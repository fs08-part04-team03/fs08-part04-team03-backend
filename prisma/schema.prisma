// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// ============================================================================
// ğŸ“Œ í…Œì´ë¸” (Models) & ê´€ê³„ (Relations)
//
//    - companies: íšŒì‚¬ ì •ë³´
//      â†’ users, products, budgetCriteria, budgets, purchaseRequests, invitations
//
//    - users: ì‚¬ìš©ì ì •ë³´
//      â† companies (ì†Œì† íšŒì‚¬)
//      â†’ carts, purchaseRequests (ìš”ì²­ì/ìŠ¹ì¸ì)
//
//    - categories: ìƒí’ˆ ì¹´í…Œê³ ë¦¬ (ê³„ì¸µ êµ¬ì¡°)
//      â†” categories (Self-relation: ìƒìœ„/í•˜ìœ„ ì¹´í…Œê³ ë¦¬)
//      â†’ products
//
//    - products: ìƒí’ˆ ì •ë³´
//      â† companies, categories
//      â†’ carts, purchaseItems
//
//    - carts: ì¥ë°”êµ¬ë‹ˆ
//      â† users, products
//
//    - budgetCriteria: íšŒì‚¬ë³„ ì˜ˆì‚° ê¸°ì¤€
//      â† companies (1:1)
//
//    - budgets: ì›”ë³„ ì˜ˆì‚°
//      â† companies
//
//    - purchaseRequests: êµ¬ë§¤ ìš”ì²­
//      â† companies, users (ìš”ì²­ì), users (ìŠ¹ì¸ì)
//      â†’ purchaseItems
//
//    - purchaseItems: êµ¬ë§¤ ìš”ì²­ ìƒì„¸ í•­ëª©
//      â† purchaseRequests, products
//
//    - invitations: ì´ë©”ì¼ ì´ˆëŒ€
//      â† companies
//
//    - History: ë³€ê²½ ì´ë ¥ (ë…ë¦½ í…Œì´ë¸”)
//
// ğŸ“Œ ì—´ê±°í˜• (Enums)
//    - role: ì‚¬ìš©ì ì—­í•  (USER, MANAGER, ADMIN)
//    - purchaseStatus: êµ¬ë§¤ ìƒíƒœ (PENDING, APPROVED, REJECTED, CANCELLED)
//    - operationType: ì´ë ¥ ì‘ì—… ìœ í˜• (INSERT, UPDATE, DELETE)
//
// ğŸ“Œ ê´€ê³„ í‘œê¸°ë²•: â†’ 1:N (ë¶€ëª¨), â† N:1 (ìì‹), â†” Self-relation
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// íšŒì‚¬ í…Œì´ë¸”
model companies {
  id               String             @id @default(uuid(7)) @db.Uuid
  name             String             @db.VarChar(255)
  businessNumber   String             @db.VarChar(255)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  budgetCriteria   budgetCriteria?
  budgets          budgets[]
  invitations      invitations[]
  products         products[]
  purchaseRequests purchaseRequests[]
  users            users[]

  @@map("companies")
}

// ì‚¬ìš©ì í…Œì´ë¸”
model users {
  id           String   @id @default(uuid(7)) @db.Uuid
  companyId    String   @db.Uuid
  email        String   @unique
  password     String
  name         String   @db.VarChar(255)
  role         role     @default(USER)
  refreshToken String?  @db.VarChar(255)
  profileImage String?  @db.VarChar(255)
  isActive     Boolean  @default(true) // ë…¼ë¦¬ì  ì‚­ì œ
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  carts              carts[]
  approvedPurchases  purchaseRequests[] @relation("Approver")
  requestedPurchases purchaseRequests[] @relation("Requester")
  companies          companies          @relation(fields: [companyId], references: [id])

  @@unique([companyId, email])
  @@map("users")
}

// ì¹´í…Œê³ ë¦¬
model categoies {
  id               Int    @id @default(autoincrement())
  name             String @db.VarChar(255)
  parentCategoryId Int?

  // Self-relation for hierarchical categories
  parentCategories categoies?  @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  childCategories  categoies[] @relation("CategoryHierarchy")

  // Relations
  products products[]

  @@map("categories")
}

// ìƒí’ˆ
model products {
  id         Int      @id @default(autoincrement())
  companyId  String   @db.Uuid
  categoryId Int
  name       String   @db.VarChar(255)
  price      Int
  image      String?  @db.VarChar(255)
  link       String   @db.VarChar(255)
  isActive   Boolean  @default(true) // ë…¼ë¦¬ì  ì‚­ì œ
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  companies     companies       @relation(fields: [companyId], references: [id])
  categoies     categoies       @relation(fields: [categoryId], references: [id])
  carts         carts[]
  purchaseItems purchaseItems[]

  @@map("products")
}

// ì¥ë°”êµ¬ë‹ˆ
model carts {
  id        String   @id @default(uuid(7)) @db.Uuid
  userId    String   @db.Uuid
  productId Int
  quantity  Int
  updatedAt DateTime @updatedAt

  // Relations
  users    users    @relation(fields: [userId], references: [id])
  products products @relation(fields: [productId], references: [id])

  @@map("carts")
}

// ì˜ˆì‚°ê¸°ì¤€
model budgetCriteria {
  id        String @id @default(uuid(7)) @db.Uuid
  companyId String @unique @db.Uuid
  amount    Int?

  // Relations
  companies companies @relation(fields: [companyId], references: [id])

  @@map("budget_criteria")
}

// ì›”ë³„ ì˜ˆì‚°
model budgets {
  id        String   @id @default(uuid(7)) @db.Uuid
  companyId String   @db.Uuid
  year      Int
  month     Int
  amount    Int
  updatedAt DateTime @updatedAt

  // Relations
  companies companies @relation(fields: [companyId], references: [id])

  @@unique([companyId, year, month])
  @@map("budgets")
}

// êµ¬ë§¤ìš”ì²­
model purchaseRequests {
  id             String         @id @default(uuid(7)) @db.Uuid
  companyId      String         @db.Uuid
  requesterId    String         @db.Uuid
  approverId     String?        @db.Uuid
  status         purchaseStatus @default(PENDING)
  totalPrice     Int
  shippingFee    Int            @default(3000)
  requestMessage String?        @db.VarChar(255)
  rejectReason   String?        @db.VarChar(255)
  reason         String?        @db.VarChar(255)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  purchaseItems purchaseItems[]
  approver      users?          @relation("Approver", fields: [approverId], references: [id])
  companies     companies       @relation(fields: [companyId], references: [id])
  requester     users           @relation("Requester", fields: [requesterId], references: [id])

  @@map("purchase_requests")
}

// êµ¬ë§¤ë‚´ì—­
model purchaseItems {
  id                String @id @default(uuid(7)) @db.Uuid
  purchaseRequestId String @db.Uuid
  productId         Int
  quantity          Int
  priceSnapshot     Int // ìš”ì²­ë‹¹ì‹œê°€ê²©

  // Relations
  purchaseRequests purchaseRequests @relation(fields: [purchaseRequestId], references: [id])
  products         products         @relation(fields: [productId], references: [id])

  @@map("purchase_items")
}

// ì´ˆëŒ€(ì´ë©”ì¼)
model invitations {
  id        String   @id @default(uuid(7)) @db.Uuid
  companyId String   @db.Uuid
  name      String   @db.VarChar(255)
  email     String   @unique @db.VarChar(255)
  token     String   @unique @db.VarChar(255)
  role      role
  isUsed    Boolean  @default(false) // ì´ˆëŒ€ì¥ì‚¬ìš©ì—¬ë¶€
  expiresAt DateTime
  isValid   Boolean  @default(true) // ì´ˆëŒ€ì¥ìœ íš¨ì—¬ë¶€
  createdAt DateTime @default(now())

  // Relations
  companies companies @relation(fields: [companyId], references: [id])

  @@map("invitations")
}

// ë³€ê²½ì´ë ¥
model History {
  id            String        @id @default(uuid(7)) @db.Uuid
  tableName     String        @db.VarChar(255)
  tableId       String        @db.Uuid
  operationType operationType
  data          Json // ê° í…Œì´ë¸”ë§ˆë‹¤ ìƒì´
  createdAt     DateTime      @default(now())

  @@map("history")
}

enum role {
  USER
  MANAGER
  ADMIN
}

enum purchaseStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum operationType {
  INSERT
  UPDATE
  DELETE
}
