generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model companies {
  id               String             @id @default(uuid(7)) @db.Uuid
  name             String             @db.VarChar(255)
  businessNumber   String             @db.VarChar(255)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  budgetCriteria   budgetCriteria?
  budgets          budgets[]
  invitations      invitations[]
  products         products[]
  purchaseRequests purchaseRequests[]
  users            users[]

  @@map("companies")
}

model users {
  id                 String             @id @default(uuid(7)) @db.Uuid
  companyId          String             @db.Uuid
  email              String             @unique
  password           String
  name               String             @db.VarChar(255)
  role               role               @default(USER)
  profileImage       String?            @db.VarChar(255)
  isActive           Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  refreshToken       String?            @db.VarChar(255)
  carts              carts[]
  approvedPurchases  purchaseRequests[] @relation("Approver")
  requestedPurchases purchaseRequests[] @relation("Requester")
  companies          companies          @relation(fields: [companyId], references: [id])

  @@unique([companyId, email])
  @@map("users")
}

model categoies {
  id               Int         @id @default(autoincrement())
  name             String      @db.VarChar(255)
  parentCategoryId Int?
  parentCategories categoies?  @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  childCategories  categoies[] @relation("CategoryHierarchy")
  products         products[]

  @@map("categories")
}

model products {
  id            Int             @id @default(autoincrement())
  companyId     String          @db.Uuid
  categoryId    Int
  name          String          @db.VarChar(255)
  price         Int
  image         String?         @db.VarChar(255)
  link          String          @db.VarChar(255)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  carts         carts[]
  categoies     categoies       @relation(fields: [categoryId], references: [id])
  companies     companies       @relation(fields: [companyId], references: [id])
  purchaseItems purchaseItems[]

  @@map("products")
}

model carts {
  id        String   @id @default(uuid(7)) @db.Uuid
  userId    String   @db.Uuid
  productId Int
  quantity  Int
  updatedAt DateTime @updatedAt
  products  products @relation(fields: [productId], references: [id])
  users     users    @relation(fields: [userId], references: [id])

  @@map("carts")
}

model budgetCriteria {
  id        String    @id @default(uuid(7)) @db.Uuid
  companyId String    @unique @db.Uuid
  amount    Int?
  companies companies @relation(fields: [companyId], references: [id])

  @@map("budget_criteria")
}

model budgets {
  id        String    @id @default(uuid(7)) @db.Uuid
  companyId String    @db.Uuid
  year      Int
  month     Int
  amount    Int
  updatedAt DateTime  @updatedAt
  companies companies @relation(fields: [companyId], references: [id])

  @@unique([companyId, year, month])
  @@map("budgets")
}

model purchaseRequests {
  id             String          @id @default(uuid(7)) @db.Uuid
  companyId      String          @db.Uuid
  requesterId    String          @db.Uuid
  approverId     String?         @db.Uuid
  status         purchaseStatus  @default(PENDING)
  totalPrice     Int
  shippingFee    Int             @default(3000)
  requestMessage String?         @db.VarChar(255)
  rejectReason   String?         @db.VarChar(255)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  purchaseItems  purchaseItems[]
  approver       users?          @relation("Approver", fields: [approverId], references: [id])
  companies      companies       @relation(fields: [companyId], references: [id])
  requester      users           @relation("Requester", fields: [requesterId], references: [id])

  @@map("purchase_requests")
}

model purchaseItems {
  id                String           @id @default(uuid(7)) @db.Uuid
  purchaseRequestId String           @db.Uuid
  productId         Int
  quantity          Int
  priceSnapshot     Int
  products          products         @relation(fields: [productId], references: [id])
  purchaseRequests  purchaseRequests @relation(fields: [purchaseRequestId], references: [id])

  @@map("purchase_items")
}

model invitations {
  id        String    @id @default(uuid(7)) @db.Uuid
  companyId String    @db.Uuid
  name      String    @db.VarChar(255)
  email     String    @unique @db.VarChar(255)
  token     String    @unique @db.VarChar(255)
  isUsed    Boolean   @default(false)
  expiresAt DateTime
  isValid   Boolean   @default(true)
  createdAt DateTime  @default(now())
  role      role
  companies companies @relation(fields: [companyId], references: [id])

  @@map("invitations")
}

model History {
  id            String        @id @default(uuid(7)) @db.Uuid
  tableName     String        @db.VarChar(255)
  tableId       String        @db.Uuid
  operationType operationType
  data          Json
  createdAt     DateTime      @default(now())

  @@map("history")
}

enum role {
  USER
  MANAGER
  ADMIN
}

enum purchaseStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum operationType {
  INSERT
  UPDATE
  DELETE
}
